name: Queue Eligibility Detector

# Ce workflow se d√©clenche quand une PR devient √©ligible pour la merge queue
on:
  pull_request:
    types: [opened, synchronize]
  check_suite:
    types: [completed]

jobs:
  detect-queue-eligibility:
    runs-on: ubuntu-latest
    # Ne s'ex√©cute que si ce n'est pas nous-m√™me pour √©viter les boucles
    if: github.event.check_suite.app.name != 'Queue Eligibility Detector'
    steps:
      - name: Check if PR is ready for merge queue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üïµÔ∏è QUEUE ELIGIBILITY DETECTOR"
          echo "============================="
          echo ""
          
          # Trouver le num√©ro de PR
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUM=${{ github.event.number }}
          else
            # Pour check_suite, chercher la PR associ√©e
            PR_NUM=$(gh pr list --state open --json number,headRefName | jq -r '.[] | select(.headRefName == "${{ github.head_ref }}") | .number' | head -1)
          fi
          
          if [ "$PR_NUM" = "" ] || [ "$PR_NUM" = "null" ]; then
            echo "‚ÑπÔ∏è  No PR found for this event"
            exit 0
          fi
          
          echo "üéØ Analyzing PR #$PR_NUM"
          echo "----------------------"
          
          # R√©cup√©rer l'√©tat de la PR
          PR_DATA=$(gh pr view $PR_NUM --json number,title,mergeable,mergeStateStatus,statusCheckRollup)
          
          echo "üìã PR: $(echo "$PR_DATA" | jq -r '.title')"
          echo "üîÑ Merge State: $(echo "$PR_DATA" | jq -r '.mergeStateStatus')"
          echo ""
          
          # Analyser les status checks requis
          CHECKS=$(echo "$PR_DATA" | jq '.statusCheckRollup')
          
          echo "üìä STATUS CHECKS ANALYSIS:"
          echo "-------------------------"
          
          # Compter les checks par √©tat
          SUCCESS_COUNT=$(echo "$CHECKS" | jq '[.[] | select(.conclusion == "SUCCESS")] | length')
          PENDING_COUNT=$(echo "$CHECKS" | jq '[.[] | select(.status == "IN_PROGRESS" or .status == "QUEUED" or .status == "PENDING")] | length')
          FAILED_COUNT=$(echo "$CHECKS" | jq '[.[] | select(.conclusion == "FAILURE" or .conclusion == "CANCELLED")] | length')
          TOTAL_COUNT=$(echo "$CHECKS" | jq 'length')
          
          echo "‚úÖ Success: $SUCCESS_COUNT"
          echo "‚è≥ Pending: $PENDING_COUNT" 
          echo "‚ùå Failed: $FAILED_COUNT"
          echo "üìä Total: $TOTAL_COUNT"
          echo ""
          
          # D√©terminer l'√©ligibilit√©
          if [ "$PENDING_COUNT" -eq 0 ] && [ "$FAILED_COUNT" -eq 0 ] && [ "$SUCCESS_COUNT" -gt 0 ]; then
            echo "üéâ QUEUE ELIGIBILITY: READY!"
            echo "============================"
            echo ""
            echo "‚úÖ All required status checks have passed"
            echo "üéØ This PR is now eligible for merge queue batching"
            echo ""
            echo "üîÆ PREDICTION:"
            echo "‚Ä¢ If Min Group Size > 1: PR will WAIT for other ‚úÖ PRs"
            echo "‚Ä¢ If enough ‚úÖ PRs accumulate: ONE queue.yml run will test the group"
            echo "‚Ä¢ If queue.yml passes: All PRs in group merge atomically"
            echo ""
            echo "üìà NEXT PHASE: Watch for merge_group events and queue.yml runs"
            
            # Regarder combien d'autres PR sont aussi pr√™tes
            echo ""
            echo "üîç OTHER READY PRS:"
            echo "------------------"
            gh pr list --state open --json number,title,statusCheckRollup | \
              jq -r '.[] | select(.number != '$PR_NUM') | select(.statusCheckRollup | map(select(.conclusion != "SUCCESS")) | length == 0) | select(.statusCheckRollup | length > 0) | "PR #\(.number): \(.title)"' || echo "No other PRs ready yet"
            
          elif [ "$PENDING_COUNT" -gt 0 ]; then
            echo "‚è≥ QUEUE ELIGIBILITY: WAITING"
            echo "============================"
            echo ""
            echo "Status checks still running..."
            echo "PR not yet eligible for merge queue"
            
          else
            echo "‚ùå QUEUE ELIGIBILITY: BLOCKED"
            echo "============================="
            echo ""
            echo "Some status checks failed"
            echo "PR cannot enter merge queue until fixed"
          fi